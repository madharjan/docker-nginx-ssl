#cloud-config
output: {all: '| tee -a /var/log/cloud-init-output.log'}

timezone: Asia/Singapore

groups:
  - docker: [vagrant]

system_info:
   distro: ubuntu
   default_user:
     name: vagrant
     lock_passwd: True
     gecos: Vagrant
     groups: [adm, audio, cdrom, dialout, dip, floppy, netdev, plugdev, sudo, video, docker]
     sudo: ["ALL=(ALL) NOPASSWD:ALL"]
     shell: /bin/bash

bootcmd:
  - [ sh, -xc, "mkdir /tmp/cloud-init/" ]
  - [ sh, -xc, "apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D" ]
  - [ sh, -xc, "echo deb https://apt.dockerproject.org/repo ubuntu-trusty main > /etc/apt/sources.list.d/docker.list" ]

apt_mirror: http://mirror.nus.edu.sg/ubuntu/
#apt_proxy: http://username:password@proxy-server:8080
apt_mirror_search_dns: false

package_upgrade: true
packages:
  - haveged
  - curl
  - unzip
  - htop
  - apt-transport-https
  - ca-certificates
  - apparmor
  - docker-engine
write_files:
  - path: /tmp/cloud-init/init.sh
    permissions: '0755'
    content: |
        #!/bin/bash

        echo "--- Init ---"

        apt-get install -y linux-image-extra-$(uname -r)
        apt-get --purge remove -y chef puppet at dbus rpcbind landscape-client open-vm-tools friendly-recovery
        apt-get autoremove -y
        userdel -r ubuntu

        echo "=== Done ==="

runcmd:
  - [ sh, -xc, "/tmp/cloud-init/init.sh" ]

final_message: "The system is finally up, after $UPTIME seconds"
